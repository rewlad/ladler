<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
<script>
"use strict";
(function(){

var loadKeyState, connectionKeyState;
function never(){ throw new Exception() }
function pong(){
    fetch("/connection",{method:"post",headers:{
        "X-r-action": "pong",
        "X-r-connection": getConnectionKey(never),
        "X-r-session": sessionKey(never)
    }})
    console.log("pong")
}
function sessionKey(orDo){ return sessionStorage.getItem("sessionKey") || orDo() }
function getLoadKey(orDo){ return loadKeyState || orDo() }
function loadKeyForSession(){ return "loadKeyForSession-" + sessionKey(never) }
function getConnectionKey(orDo){ return connectionKeyState || orDo() }
function sseConnect(event) {
    console.log("conn: "+event.data)
    connectionKeyState = event.data
    sessionKey(()=>sessionStorage.setItem("sessionKey", getConnectionKey(never)))
    getLoadKey(()=>{ loadKeyState = getConnectionKey(never) })
    localStorage.setItem(loadKeyForSession(), getLoadKey(never))
    pong()
}
function ssePing(event) {
    console.log("ping: "+event.data)
    if(localStorage.getItem(loadKeyForSession()) !== getLoadKey(never)) window.close() // tab was refreshed/duplicated
    if(getConnectionKey(never) === event.data) pong() // was not reconnected
}



var eventSource
var closedCount = 0

function isStateClosed(v){ return v === 2 }

function checkReconnect(){
    if(eventSource){
        closedCount = isStateClosed(eventSource.readyState) ? closedCount + 1 : 0
        if(closedCount > 0) console.log("closedCount: "+closedCount)
        if(closedCount > 5){
            eventSource.close();
            eventSource = null;
        }
    }
    if(!eventSource){
        console.log("new EventSource")
        eventSource = new EventSource("http://localhost:5556/sse");
        eventSource.addEventListener("connect",sseConnect);
        eventSource.addEventListener("ping",ssePing);
        eventSource.addEventListener("show",sseShow);
    }
}

setInterval(checkReconnect,1000);
checkReconnect();


var dataToShow
function sseShow(event){
    // console.log((new Date).getTime() % 10000,event.data % 100)
    dataToShow = event.data
}
function animationFrame(){
    document.body.textContent = dataToShow
    requestAnimationFrame(animationFrame)
}
requestAnimationFrame(animationFrame)

})()
</script>
</head>
<body>

</body>
</html>